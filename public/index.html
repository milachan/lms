<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXAMBROWSER - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 16px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-card h3 {
            color: #999;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .number {
            color: #667eea;
            font-size: 36px;
            font-weight: bold;
        }

        .tabs {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .tab-buttons {
            display: flex;
            background: #f5f5f5;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-btn {
            flex: 1;
            padding: 20px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .search-add-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }

        .search-box {
            flex: 1;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .search-box:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #48bb78;
            color: white;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-warning {
            background: #ed8936;
            color: white;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: #f5f5f5;
        }

        th {
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
        }

        tbody tr:hover {
            background: #fafafa;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #c6f6d5;
            color: #22543d;
        }

        .badge-danger {
            background: #fed7d7;
            color: #742a2a;
        }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            margin-bottom: 25px;
        }

        .modal-header h2 {
            color: #333;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .log-time {
            color: #999;
            font-size: 13px;
        }

        @media (max-width: 768px) {
            .search-add-bar {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            table {
                font-size: 14px;
            }

            th, td {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìö EXAMBROWSER Admin Dashboard</h1>
            <p>Kelola data siswa dan pantau aktivitas login ujian</p>
        </div>

        <!-- Statistics -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3>Total Siswa</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Siswa Aktif</h3>
                <div class="number" id="activeStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>Total Login</h3>
                <div class="number" id="totalLogins">0</div>
            </div>
            <div class="stat-card">
                <h3>Login Hari Ini</h3>
                <div class="number" id="todayLogins">0</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('students')">
                    üë• Data Siswa
                </button>
                <button class="tab-btn" onclick="switchTab('examlock')">
                    üîí Kunci Ujian
                </button>
                <button class="tab-btn" onclick="switchTab('sessions')">
                    üîê Sesi Aktif
                </button>
                <button class="tab-btn" onclick="switchTab('logs')">
                    üìä Log Aktivitas
                </button>
            </div>

            <!-- Students Tab -->
            <div id="students-tab" class="tab-content active">
                <div class="search-add-bar">
                    <input type="text" class="search-box" id="searchInput" 
                           placeholder="üîç Cari nama, username, atau kelas...">
                    <button class="btn btn-primary" onclick="openAddModal()">
                        ‚ûï Tambah Siswa
                    </button>
                </div>

                <div id="studentsTable"></div>
            </div>

            <!-- Exam Lock Tab -->
            <div id="examlock-tab" class="tab-content">
                <div style="padding: 30px;">
                    <h2 style="color: #667eea; margin-bottom: 20px;">üîí Pengaturan Kunci Ujian</h2>
                    
                    <!-- Status Card -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; margin-bottom: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h3 style="margin: 0 0 10px 0; font-size: 24px;">Status Ujian</h3>
                                <p id="examStatusText" style="margin: 0; font-size: 16px; opacity: 0.9;">Loading...</p>
                            </div>
                            <div>
                                <button id="quickLockBtn" class="btn" style="background: white; color: #667eea; font-size: 16px; padding: 12px 30px;" onclick="quickToggleLock()">
                                    üîí Loading...
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Form -->
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1);">
                        <h3 style="margin-bottom: 20px; color: #333;">‚öôÔ∏è Konfigurasi Ujian</h3>
                        
                        <form id="examConfigForm">
                            <div class="form-group">
                                <label>üìù Nama Ujian</label>
                                <input type="text" id="examName" placeholder="Contoh: Ujian Tengah Semester Gasal 2025" required>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div class="form-group">
                                    <label>‚è∞ Waktu Mulai</label>
                                    <input type="datetime-local" id="startTime" required>
                                </div>

                                <div class="form-group">
                                    <label>‚è±Ô∏è Waktu Selesai</label>
                                    <input type="datetime-local" id="endTime" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>üîë Password Darurat (untuk keluar paksa)</label>
                                <input type="password" id="emergencyPassword" placeholder="Minimal 6 karakter" required>
                                <small style="color: #999; margin-top: 5px; display: block;">Password ini digunakan siswa untuk keluar darurat jika ada masalah</small>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="allowRefresh" style="width: 20px; height: 20px; margin-right: 10px;">
                                        <span>üîÑ Izinkan Refresh Halaman</span>
                                    </label>
                                </div>

                                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="allowBack" style="width: 20px; height: 20px; margin-right: 10px;">
                                        <span>‚¨ÖÔ∏è Izinkan Tombol Back</span>
                                    </label>
                                </div>
                            </div>

                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                <strong>‚ö†Ô∏è Peringatan:</strong>
                                <p style="margin: 5px 0 0 0; color: #856404;">
                                    Saat ujian dikunci, siswa TIDAK BISA keluar dari aplikasi sampai waktu selesai kecuali dengan password darurat.
                                </p>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary" style="flex: 1;">
                                    üíæ Simpan Konfigurasi
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="loadExamConfig()">
                                    üîÑ Reset
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Current Timer (if exam is active) -->
                    <div id="examTimer" style="display: none; background: #d4edda; border-left: 4px solid #28a745; padding: 20px; border-radius: 10px; margin-top: 20px;">
                        <h4 style="margin: 0 0 10px 0; color: #155724;">‚è≥ Ujian Sedang Berlangsung</h4>
                        <p style="margin: 0; font-size: 24px; font-weight: bold; color: #155724;" id="timeRemaining">--:--:--</p>
                    </div>
                </div>
            </div>

            <!-- Sessions Tab -->
            <div id="sessions-tab" class="tab-content">
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üîê Sesi Login Aktif</h3>
                        <button class="btn btn-secondary" onclick="loadActiveSessions()">üîÑ Refresh</button>
                    </div>
                    <div id="sessionsTable"></div>
                </div>
            </div>

            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div id="logsTable"></div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Student Modal -->
    <div id="studentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Tambah Siswa Baru</h2>
            </div>
            <form id="studentForm">
                <input type="hidden" id="studentId">
                
                <div class="form-group">
                    <label>Nama Lengkap *</label>
                    <input type="text" id="studentName" required 
                           placeholder="Contoh: Ahmad Rifai">
                </div>

                <div class="form-group">
                    <label>Username *</label>
                    <input type="text" id="studentUsername" required 
                           placeholder="Contoh: ahmad.rifai">
                </div>

                <div class="form-group">
                    <label>Kelas *</label>
                    <input type="text" id="studentClass" required 
                           placeholder="Contoh: XII IPA 1">
                </div>

                <div class="form-group">
                    <label>Status</label>
                    <select id="studentActive">
                        <option value="true">Aktif</option>
                        <option value="false">Tidak Aktif</option>
                    </select>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-success" style="flex: 1;">
                        üíæ Simpan
                    </button>
                    <button type="button" class="btn btn-danger" onclick="closeModal()" style="flex: 1;">
                        ‚ùå Batal
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:3000/api' 
            : '/api';

        let students = [];
        let logs = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadStats();
            loadStudents();
            loadLogs();

            // Search functionality
            document.getElementById('searchInput').addEventListener('input', (e) => {
                filterStudents(e.target.value);
            });

            // Form submit
            document.getElementById('studentForm').addEventListener('submit', handleSubmit);
        });

        // Switch tabs
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`${tab}-tab`).classList.add('active');

            if (tab === 'examlock') {
                loadExamConfig();
            } else if (tab === 'sessions') {
                loadActiveSessions();
            } else if (tab === 'logs') {
                loadLogs();
            }
        }

        // ==================== EXAM LOCK MANAGEMENT ====================

        let examTimerInterval = null;

        // Load exam configuration
        async function loadExamConfig() {
            try {
                const response = await fetch(`${API_URL}/exam-config`);
                const result = await response.json();

                if (result.success) {
                    const config = result.data;
                    
                    // Populate form
                    document.getElementById('examName').value = config.examName || '';
                    document.getElementById('emergencyPassword').value = config.emergencyPassword || '';
                    document.getElementById('allowRefresh').checked = config.allowRefresh || false;
                    document.getElementById('allowBack').checked = config.allowBack || false;
                    
                    // Format datetime for input
                    if (config.startTime) {
                        document.getElementById('startTime').value = formatDateTimeLocal(config.startTime);
                    }
                    if (config.endTime) {
                        document.getElementById('endTime').value = formatDateTimeLocal(config.endTime);
                    }
                    
                    // Update status display
                    updateExamStatus(config);
                    
                    // Start timer if exam is active
                    if (config.isActive) {
                        startExamTimer(config.endTime);
                    } else {
                        stopExamTimer();
                    }
                }
            } catch (error) {
                console.error('Error loading exam config:', error);
                alert('‚ùå Gagal memuat konfigurasi ujian');
            }
        }

        // Update exam status display
        function updateExamStatus(config) {
            const statusText = document.getElementById('examStatusText');
            const lockBtn = document.getElementById('quickLockBtn');
            
            if (config.isActive) {
                statusText.innerHTML = `üî¥ <strong>UJIAN SEDANG BERLANGSUNG</strong><br>
                    <small>${config.examName}</small><br>
                    <small>Mulai: ${formatDateTime(config.startTime)} | Selesai: ${formatDateTime(config.endTime)}</small>`;
                lockBtn.innerHTML = 'üîì Buka Kunci';
                lockBtn.style.background = '#f56565';
                lockBtn.style.color = 'white';
            } else if (config.isLocked) {
                statusText.innerHTML = `üü° <strong>UJIAN TERJADWAL (TERKUNCI)</strong><br>
                    <small>${config.examName}</small><br>
                    <small>Mulai: ${formatDateTime(config.startTime)} | Selesai: ${formatDateTime(config.endTime)}</small>`;
                lockBtn.innerHTML = 'üîì Buka Kunci';
                lockBtn.style.background = 'white';
                lockBtn.style.color = '#667eea';
            } else {
                statusText.innerHTML = `üü¢ <strong>UJIAN TIDAK TERKUNCI</strong><br>
                    <small>Siswa dapat keluar dari aplikasi kapan saja</small>`;
                lockBtn.innerHTML = 'üîí Kunci Ujian';
                lockBtn.style.background = 'white';
                lockBtn.style.color = '#667eea';
            }
        }

        // Quick toggle lock/unlock
        async function quickToggleLock() {
            try {
                const response = await fetch(`${API_URL}/exam-config`);
                const result = await response.json();
                const currentLock = result.data.isLocked;
                
                const action = currentLock ? 'unlock' : 'lock';
                const confirmMsg = currentLock 
                    ? 'Yakin ingin MEMBUKA KUNCI ujian?\n\nSiswa akan bisa keluar dari aplikasi.'
                    : 'Yakin ingin MENGUNCI ujian?\n\nSiswa TIDAK BISA keluar dari aplikasi sampai waktu selesai.';
                
                if (!confirm(confirmMsg)) return;
                
                const lockResponse = await fetch(`${API_URL}/exam-lock`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                const lockResult = await lockResponse.json();
                
                if (lockResult.success) {
                    alert(`‚úÖ ${lockResult.message}`);
                    loadExamConfig();
                }
            } catch (error) {
                console.error('Error toggling lock:', error);
                alert('‚ùå Gagal mengubah status kunci');
            }
        }

        // Save exam configuration
        document.getElementById('examConfigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            try {
                const formData = {
                    isLocked: true,  // Auto lock when saving
                    examName: document.getElementById('examName').value,
                    startTime: new Date(document.getElementById('startTime').value).toISOString(),
                    endTime: new Date(document.getElementById('endTime').value).toISOString(),
                    emergencyPassword: document.getElementById('emergencyPassword').value,
                    allowRefresh: document.getElementById('allowRefresh').checked,
                    allowBack: document.getElementById('allowBack').checked
                };
                
                // Validate password length
                if (formData.emergencyPassword.length < 6) {
                    alert('‚ùå Password darurat minimal 6 karakter!');
                    return;
                }
                
                const response = await fetch(`${API_URL}/exam-config`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ ' + result.message + '\n\nüîí Ujian otomatis dikunci!');
                    loadExamConfig();
                } else {
                    alert('‚ùå ' + result.message);
                }
            } catch (error) {
                console.error('Error saving exam config:', error);
                alert('‚ùå Gagal menyimpan konfigurasi');
            }
        });

        // Start exam timer
        function startExamTimer(endTime) {
            stopExamTimer(); // Clear existing timer
            
            document.getElementById('examTimer').style.display = 'block';
            
            examTimerInterval = setInterval(() => {
                const now = new Date();
                const end = new Date(endTime);
                const diff = end - now;
                
                if (diff <= 0) {
                    document.getElementById('timeRemaining').textContent = 'UJIAN SELESAI';
                    document.getElementById('examTimer').style.background = '#f8d7da';
                    document.getElementById('examTimer').style.borderColor = '#dc3545';
                    stopExamTimer();
                    loadExamConfig(); // Reload to update status
                } else {
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    
                    document.getElementById('timeRemaining').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')} tersisa`;
                }
            }, 1000);
        }

        // Stop exam timer
        function stopExamTimer() {
            if (examTimerInterval) {
                clearInterval(examTimerInterval);
                examTimerInterval = null;
            }
            document.getElementById('examTimer').style.display = 'none';
        }

        // Utility: Format datetime for datetime-local input
        function formatDateTimeLocal(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // Utility: Format datetime for display
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            return new Date(isoString).toLocaleString('id-ID', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ==================== END EXAM LOCK MANAGEMENT ====================

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/stats`);
                const result = await response.json();

                if (result.success) {
                    document.getElementById('totalStudents').textContent = result.data.totalStudents;
                    document.getElementById('activeStudents').textContent = result.data.activeStudents;
                    document.getElementById('totalLogins').textContent = result.data.totalLogins;
                    document.getElementById('todayLogins').textContent = result.data.todayLogins;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load students
        async function loadStudents(search = '') {
            try {
                const url = search ? `${API_URL}/students?search=${encodeURIComponent(search)}` : `${API_URL}/students`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success) {
                    students = result.data;
                    renderStudents();
                }
            } catch (error) {
                console.error('Error loading students:', error);
                document.getElementById('studentsTable').innerHTML = 
                    '<div class="empty-state">‚ùå Gagal memuat data siswa</div>';
            }
        }

        // Render students table
        function renderStudents() {
            const container = document.getElementById('studentsTable');

            if (students.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                        </svg>
                        <h3>Belum ada data siswa</h3>
                        <p>Klik tombol "Tambah Siswa" untuk menambahkan data baru</p>
                    </div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Nama</th>
                            <th>Username</th>
                            <th>Kelas</th>
                            <th>Status</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${students.map(student => `
                            <tr>
                                <td>${student.id}</td>
                                <td><strong>${student.name}</strong></td>
                                <td>${student.username}</td>
                                <td>${student.class}</td>
                                <td>
                                    <span class="badge ${student.active ? 'badge-success' : 'badge-danger'}">
                                        ${student.active ? '‚úì Aktif' : '‚úó Tidak Aktif'}
                                    </span>
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <button class="btn btn-warning btn-sm" onclick="editStudent(${student.id})">
                                            ‚úèÔ∏è Edit
                                        </button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteStudent(${student.id})">
                                            üóëÔ∏è Hapus
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Filter students
        function filterStudents(search) {
            loadStudents(search);
        }

        // Load active sessions
        async function loadActiveSessions() {
            try {
                const response = await fetch(`${API_URL}/active-sessions`);
                const result = await response.json();

                if (result.success) {
                    renderActiveSessions(result.data);
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                document.getElementById('sessionsTable').innerHTML = 
                    '<div class="empty-state">‚ùå Gagal memuat sesi aktif</div>';
            }
        }

        // Render active sessions
        function renderActiveSessions(sessions) {
            const container = document.getElementById('sessionsTable');

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 64px; height: 64px; margin: 0 auto 20px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        <h3>Tidak ada sesi aktif</h3>
                        <p>Sesi akan muncul ketika siswa login melalui aplikasi</p>
                    </div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Siswa</th>
                            <th>Device ID</th>
                            <th>Waktu Login</th>
                            <th>Session ID</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sessions.map(session => `
                            <tr>
                                <td>
                                    <strong>${session.studentName}</strong>
                                    <br><small style="color: #999;">ID: ${session.studentId}</small>
                                </td>
                                <td>
                                    <code style="background: #f0f0f0; padding: 4px 8px; border-radius: 4px; font-size: 12px;">
                                        ${session.deviceId.substring(0, 20)}...
                                    </code>
                                </td>
                                <td>${new Date(session.timestamp).toLocaleString('id-ID')}</td>
                                <td>
                                    <code style="background: #e7f3ff; padding: 4px 8px; border-radius: 4px; font-size: 11px; color: #0066cc;">
                                        ${session.sessionId.substring(0, 25)}...
                                    </code>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Load logs
        async function loadLogs() {
            try {
                const response = await fetch(`${API_URL}/login-logs?limit=50`);
                const result = await response.json();

                if (result.success) {
                    logs = result.data;
                    renderLogs();
                }
            } catch (error) {
                console.error('Error loading logs:', error);
                document.getElementById('logsTable').innerHTML = 
                    '<div class="empty-state">‚ùå Gagal memuat log aktivitas</div>';
            }
        }

        // Render logs table
        function renderLogs() {
            const container = document.getElementById('logsTable');

            if (logs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3>Belum ada aktivitas login</h3>
                        <p>Log akan muncul ketika siswa login melalui aplikasi</p>
                    </div>
                `;
                return;
            }

            const html = `
                <table>
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>ID</th>
                            <th>Nama Siswa</th>
                            <th>Username</th>
                            <th>Device Info</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${logs.map(log => {
                            const date = new Date(log.timestamp);
                            const timeStr = date.toLocaleString('id-ID', {
                                day: '2-digit',
                                month: 'short',
                                year: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });

                            return `
                                <tr>
                                    <td class="log-time">${timeStr}</td>
                                    <td>${log.studentId}</td>
                                    <td><strong>${log.studentName}</strong></td>
                                    <td>${log.username}</td>
                                    <td>${log.deviceInfo}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        // Modal functions
        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Tambah Siswa Baru';
            document.getElementById('studentForm').reset();
            document.getElementById('studentId').value = '';
            document.getElementById('studentModal').classList.add('active');
        }

        function editStudent(id) {
            const student = students.find(s => s.id === id);
            if (!student) return;

            document.getElementById('modalTitle').textContent = 'Edit Data Siswa';
            document.getElementById('studentId').value = student.id;
            document.getElementById('studentName').value = student.name;
            document.getElementById('studentUsername').value = student.username;
            document.getElementById('studentClass').value = student.class;
            document.getElementById('studentActive').value = student.active.toString();
            document.getElementById('studentModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('studentModal').classList.remove('active');
        }

        // Handle form submit
        async function handleSubmit(e) {
            e.preventDefault();

            const id = document.getElementById('studentId').value;
            const data = {
                name: document.getElementById('studentName').value,
                username: document.getElementById('studentUsername').value,
                class: document.getElementById('studentClass').value,
                active: document.getElementById('studentActive').value === 'true'
            };

            try {
                const url = id ? `${API_URL}/students/${id}` : `${API_URL}/students`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úì Data siswa berhasil ${id ? 'diupdate' : 'ditambahkan'}!`);
                    closeModal();
                    loadStudents();
                    loadStats();
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error saving student:', error);
                alert('‚ùå Gagal menyimpan data siswa');
            }
        }

        // Delete student
        async function deleteStudent(id) {
            const student = students.find(s => s.id === id);
            if (!confirm(`Hapus siswa "${student.name}"?\nData tidak bisa dikembalikan!`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/students/${id}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    alert('‚úì Data siswa berhasil dihapus!');
                    loadStudents();
                    loadStats();
                } else {
                    alert(`‚ùå Error: ${result.message}`);
                }
            } catch (error) {
                console.error('Error deleting student:', error);
                alert('‚ùå Gagal menghapus data siswa');
            }
        }

        // Auto refresh stats and logs every 30 seconds
        setInterval(() => {
            loadStats();
            if (document.getElementById('logs-tab').classList.contains('active')) {
                loadLogs();
            }
        }, 30000);
    </script>
</body>
</html>
